Example: Schedule nightly *test runs* on permanent a *target*
-------------------------------------------------------------

Schedule nightly *test runs* of all tests.

A permanent *target* will be provisioned. *Test run* and its scheduling will be configured on *master* using inventory generated by provisioning. The configuration will be updated later as needed. And when no longer needed, the *target* will be destroyed. The results will be synced to remote *results host* after each *test run*.

For alternative approach to *test run* scheduling see also this [example](../example4).

#### Resources configuration:

[PinFile](PinFile)

#### Test configuration:

Unlike when [using temporary *target*](../example4), we will use the local `kickstart-tests` repository as a place where we keep the *target* configuration. We can track the configuration for the *target* in files overriding default configuration added to the repository.

[test-configuration.yml](test-configuration.yml) contains modifications to the [default configuration](../../../ansible/roles/kstest-master/defaults/main/test-configuration.yml)

* `kstest_boot_iso_url` - `boot.iso` with installer to be tested
* `kstest_url` - url of the installation repository to be used for the test (should correspond to the `kstest_boot_iso_url`)
* `kstest_ftp_url` - FTP url of installation repository (required for `ftp` tests).
* `kstest_result_run_dir_prefix` - prefix to be added to subdirectories storing *test run* results
* `kstest_remote_results_path` - location of *results host*
* `kstest_remote_results_keep_local` - do not keep results of nightly runs on *master*

[schedule.yml](schedule.yml) contains modifications to the [default configuration](../../../ansible/roles/kstest-master/defaults/main/schedule.yml)


#### The lifecycle:

1) Provision the permanent *target*

We are using existing [ssh key](../../README.md#ssh-keys) (`--key-use-existing`) that will need to be added to authorized keys of *restults host* in the next step. The path to the private key (`--ansible-private-key`) that will be used also as *master* key (`--key-use-for-master`) needs to be supplied so it can be added to the *master* during its deployment.

```
scripts/kstests-in-cloud.sh provision nightly-permanent --pinfile examples/example5/PinFile --key-name kstests --key-use-existing --ansible-private-key ~/.ssh/kstests.pem --key-use-for-master
```

2) Add ssh key to *results host*

The `kstests` public key needs to be added to *result host* so that *master* can rsync the results.

3) Create test and scheduling configuration

Copy the example configuration files to the ansible role's [location](../../../ansible/roles/kstest-master/vars/main) from which the role's defaults will be overriden.


```
cp linchpin/examples/example5/test-configuration.yml ansible/roles/kstest-master/vars/main/test-configuration.yml
cp linchpin/examples/example5/schedule.yml ansible/roles/kstest-master/vars/main/schedule.yml
```

You may want to track the files in git repository (also to be aware that the default configuration will be actually overriden when running tests from this repository):
```
git add ansible/roles/kstest-master/vars/main/test-configuration.yml
git add ansible/roles/kstest-master/vars/main/schedule.yml
```

4) Use the inventory generated with provisioning


When applying the configuration for the first time it can be useful to set up the inventory for the local `kicstart-tests` repository so that it does not have to be passed to `ansible-playbook` with `-i` option each time the configuration is applied (or other playbook is run).

To get the path of the `nightly-parmanent` *target*'s inventory run:

```
scripts/kstests-in-cloud.sh status --show-inventory nightly-permanent
```
showing:
```
Target "nightly-permanent" has generated inventory linchpin/inventories/nightly-permanent.inventory
```
To configure ansible locally to use the inventory create local ansible configuration for the current directory:

```
echo -e "[defaults]\ninventory=linchpin/inventories/nightly-permanent.inventory" >  ansible.cfg
```
and perhaps add it to git for tracking
```
git add ansible.cfg
```

5) Apply the configuration to *master*:

```
ansible-playbook ansible/kstest-master-configure-test.yml
```

Or, if not using local `ansible.cfg` from 4., configure the inventory with `-i` option:
```
ansible-playbook -i linchpin/inventories/nightly-permanent.inventory ansible/kstest-master-configure-test.yml
```

6) Configure the scheduling on *master*:

```
ansible-playbook ansible/kstest-master-schedule-test.yml
```
Check that the scheduling was applied to *master*:
```
$ ansible kstest-master -a "crontab -l -u kstest" --become
10.8.243.115 | CHANGED | rc=0 >>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
#Ansible: Scheduled kickstart tests
5 0 * * * /home/kstest/run_tests.sh
```
30) When needed, update and apply the configuration again

```
vim ansible/roles/kstest-master/vars/main/test-configuration.yml
ansible-playbook ansible/kstest-master-configure-test.yml
```

40) Or change the scheduled time

```
vim ansible/roles/kstest-master/vars/main/schedule.yml
ansible-playbook ansible/kstest-master-schedule-test.yml
```

Or - if you do not want to track the configuration in the schedule.yml file (as in 3.), configure the variable value via `--extra-vars`:
```
ansible-playbook ansible/kstest-master-schedule-test.yml --extra-vars='kstest_master_cron_hour=23'
```

50) Disable the scheduling
```
ansible-playbook ansible/kstest-master-schedule-test.yml --extra-vars='kstest_master_cron_disabled=true'
```

Check that it is really disabled:
```
$ ansible kstest-master -a "crontab -l -u kstest" --become
10.8.243.115 | CHANGED | rc=0 >>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
#Ansible: Scheduled kickstart tests
#5 0 * * * /home/kstest/run_tests.sh
```

51) Execute a *test run* on the *master* immediately

Current test configuration on *master* will be used, results will be synced to *results host*.
```
ansible-playbook ansible/kstest-master-run-test.yml
```

60) Look at the results

On the *results host*:

```
$ tree -L 2 /mnt/kstests/results
/mnt/kstests/results/
└── runs
    ├── rawhide.2018-11-02-00_10_30
    └── rawhide.2018-11-03-00_09_12
```
The prefix `rawhide.` is configured in [test-configuration.yml](test-configuration.yml).


A rudimentary script is available to produce history of the *test runs* from a given directory on single html page with links to the test logs:

```
ansible/roles/kstest-master/files/scripts/kstests_history.py /mnt/kstests/results/runs > /mnt/kstests/results/summary.html
```

The script can be passed `-s NUMBER_OF_RUNS` option that would mark tests with interesting (failing) results based on latest `NUMBER_OF_RUNS` runs.


99) Destroy the *target*

```
scripts/kstests-in-cloud.sh destroy nightly-permanent --pinfile examples/example5/PinFile
```



