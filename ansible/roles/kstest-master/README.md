Running kickstart tests from remote host
========================================

Using this role with playbook `kstest-master.yml` a host created for running kickstart tests (as created with [kstest role](../kstest)) can be further configured as a host from which the tests on other hosts are run (`kstest-master`). The tests are run from git repository on the `kstest-master` and the results are stored on the `kstest-master`. There is also an option to configure syncing the results to another system using `rsync`, and to configure running the tests periodically on `kstest-master` using ``cron``.

Host deployment
---------------

The host is deployed  with `kstest-master.yml` playbook which depends on [kstest role](../kstest) and can be run either on top of the host deployed by `kstest.yml` or on a freshly provisioned host.

Before running the playbook:

* Inventory and ansible configuration has to be updated based on the provisioned hosts - see [README](../../README.md).
* Public keys authorized to run tests on the hosts may need to be added to [authorized_keys](../kstest/files/authorized_keys) directory (if it has not already been done while deploying `kstest` remote host).
* Path to private key authorizing master to run tests on remote hosts (eg hosts deployed by `kstest` playbook) has to be added to [vars/main.yml](vars/main.yml) `kstest.master.private_ssh_key` variable. The key will be copied to `kstest-master`.

The deployment is done by running:

```
ansible-playbook kstest-master.yml
```


Configuration of a test run
---------------------------

The test run can be configured in [defaults/main.yml](defaults/main.yml) file.

The configuration is applied to the host by running:

```
ansible-playbook --tags config-test kstest-master.yml
```

The values from the file can be overriden by `--extra-vars` option when running the play, for example to set the tests that should be run use:

```
ansible-playbook --tags config-test --extra-vars 'kstest_tests_to_run="hostname.sh user.sh"' kstest-master.yml
```

Scheduling a test run
---------------------

To schedule the test run on `kstest-master` host configure the `kstest.master.cron.*` variables in [vars/main.yml](vars/main.yml) file and rerun the kstest-master.yml playbook.

```
ansible-playbook --tags schedule-test kstest-master.yml
```

The `--tags` option is not required, it makes ansible run only tasks related to scheduling. Running the complete playbook would work as well, only take a bit longer time.

Running the test manually
-------------------------

To run the test manually use:

```
ansible kstest-master -m shell -a "PATH=$PATH:/usr/sbin ~/run_tests.sh" -u kstest
```

The `kstest` user is expected to be the remote runner of test scripts as of now, which is reflected in the `kstest_remote_user` variable of `kstest` role ([../kstest/vars/main.yml](../kstest/vars/main.yml)).


Test results
------------

Test results and logs are stored on `kstest-master` host in `results` kstest user's home subdirectory (eg `/home/kstest/results`)

```
└── results
    ├── runs
    │   └── 2018-06-03-22_00_02
    │       ├── isomd5sum.txt
    │       ├── kstest-autopart-encrypted-1.EfLCR2oF
    │       ├── kstest-bindtomac-ifname-httpks.fb8MlKI6
    │       ├── kstest-bootloader-4.DNBcteR2
    │       ├── kstest-clearpart-3.nACu3YPn
    │       ├── kstest.log
    │       ├── result_report.txt
    │       └── test_parameters.txt
    └── summary.html
```

* `runs` directory contains subdirectories with test run results
* `isomd5sum.txt` contains md5 sum of the installer iso used for the test
* `kstest.log` is the output of `run_kickstart_tests.sh` command
* `result_report.txt` is an overall test run report generated by `scripts/run_results.sh` from `kstest.log`
* `test_parameters.txt` contains information about parameters of the test run (used repo, consumed time, ...)
* `summary.html` is a summary generated from all the runs in `runs` directory using the script defined in [vars/main.yml](vars/main.yml) with `kstest.master.results_summary_script.*` variables. If the values are defined the summary script is run at the end of test run.

Syncing results to a remote system
----------------------------------

The test run can be configured to sync the results directory to a remote host after the run with `kstest_remote_results_*` variables in [defaults/main.yml](defaults/main.yml)

NOTE: `kstest-master` needs to be authorized for non-interactive rsync access to the remote host, eg by adding its key.
