Provisioning hosts for remote tests in a cloud
==============================================

Using `linchpin` the hosts can be provisioned and respective inventory created for deployment of the hosts for remote tests using [ansible playbooks](../ansible).

Linchpin installation
---------------------

Linchpin `pip` installation in `virtualenv` is desribed in [documentation](https://linchpin.readthedocs.io)

Credentials
-----------

* The cloud credentials need to be configured in the file and profile reffered by `credentials` variable of [topologies/kstests.yml](topologies/kstests.yml). So the credentials file `clouds.yml` should contain profile `ci-rhos`. The path to the directory containing the file is provided by `linchpin` `--creds-path` option.

```
clouds:
  ci-rhos:
    auth:
      auth_url:
      project_name:
      username:
      password:
```

* Ssh keys for provisioned hosts are defined in [topologies/kstests.yml](topologies/kstests.yml), for example by `keypair` value for openstack. The key will be later needed to [configure](../ansible/ansible.cfg) ansible for running the [deployment playbooks](../ansible) on the provisioned hosts.


Configuration
-------------

* Number of hosts to be provisioned can be configured by `count` variable in [topologies/kstests.yml](topologies/kstests.yml) and [layouts/kstests.yml](layouts/kstests.yml).

  * `kstest` are hosts on which remote tests are to be run (deployed by [kstest](../ansible/roles/kstest) role)
  * `kstest-master` is a host from which remote tests can be run (deployed by [kstest-master](../ansible/roles/kstest-master))

* The provisioning parameters (image, host flavor, etc...) are configured in [topologies/kstests.yml](topologies/kstests.yml).

Example: a test run from a local host on remote hosts in a cloud
----------------------------------------------------------------

The test will be run from local host on `kstest` hosts provisioned with `linchpin` and deployed with `kstest` ansible playbook.

* The cloud credentials and number of `kstest` instances should be configured as described above in [Configuration](#configuration). There is no need for `kstest-master` instance.
* Ansible and the deployment playbook should be configured as described in [kstest](../ansible/roles/kstest#remote-hosts-deployment) role

From the `kickstart-tests` directory provision and deploy remote hosts (`kstest` instances):

```
rm linchpin/inventories/kstests-*.inventory
linchpin -v --creds-path <PATH_TO_CREDENTIALS> --workspace linchpin -p linchpin/PinFile -c linchpin/linchpin.conf up
cp linchpin/inventories/kstests-*.inventory ansible/inventory/linchpin.kstests
cd ansible
ansible-playbook kstest.yml
cd -
```

IP addresses of provisioned hosts can be found in the inventory generated by `linchpin`:
```
cat ansible/inventory/linchpin.kstests
```

Run the test providing the IP addresses from the inventory:
```
$ TEST_REMOTES=<IP1 IP2 ...> TEST_REMOTES_ONLY=yes scripts/run_kickstart_tests.sh -i ../boot.iso -k 1 hostname.sh user.sh
```
(see [kstest](../ansible/roles/kstest#running-the-test) role documentation for details)

To remove the hosts from the cloud:
```
$ linchpin -v --creds-path <PATH_TO_CREDENTIALS> --workspace linchpin -p linchpin/PinFile -c linchpin/linchpin.conf destroy
```
Example: a test run completely in a cloud
-----------------------------------------

The test will be run from `kstest-master` on the master and additional `kstest` hosts.

* The cloud credentials and number of `kstest` instances should be configured as described above.
* Ansible and the deployment playbooks should be configured as described in [../ansible/README.md](../ansible/README.md)
* The test parameters can be configured as described in [kstest-master](../ansible/roles/kstest-master) role.
  * either by modifying the ansible variables file before running the `kstest-master.yml` playbook in the script
  * or by supplying the values via `--extra-vars` option to the `kstest-master.yml` playbook in the script

Example of a script that would be run from kickstart-tests repository directory.

```
#!/bin/bash

set -ex

# Clean up linchpin inventory dir
rm linchpin/inventories/kstests-*.inventory

# Provision the hosts
linchpin -v --creds-path <PATH_TO_CREDENTIALS> --workspace linchpin -p linchpin/PinFile -c linchpin/linchpin.conf up

# Pass resulting inventory to ansible
cp linchpin/inventories/kstests-*.inventory ansible/inventory/linchpin.kstests

cd ansible

# Deploy the hosts
ansible-playbook kstest.yml

# Deploy the master and configure the test
ansible-playbook kstest-master.yml

# Run the test
ansible kstest-master -m shell -a "PATH=$PATH:/usr/sbin ~/run_tests.sh" -u kstest

cd -

# Destroy the provisioned hosts
linchpin -v --creds-path <PATH_TO_CREDENTIALS> --workspace linchpin -p linchpin/PinFile -c linchpin/linchpin.conf destroy
```
