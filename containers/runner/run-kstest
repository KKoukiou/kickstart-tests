#!/bin/sh

set -o pipefail -ex

KSTESTS_REPOSITORY=${KSTESTS_REPOSITORY:-https://github.com/rhinstaller/kickstart-tests}
KSTESTS_BRANCH=${KSTESTS_BRANCH:-master}
KSTESTS_DIR=${APP_ROOT}/kickstart-tests
KSTESTS_TEST=${KSTESTS_TEST:-}
KSTESTS_KEEP=${KSTESTS_KEEP:-1}

UPDATES_IMAGE=${UPDATES_IMAGE:-""}
BOOT_ISO=${BOOT_ISO:-boot.iso}
ISO_DIR=${APP_DATA}/images
LOGS_DIR=${APP_DATA}/logs

# user can bind-mount a local kickstart-tests dir to test that
if [ -d /kickstart-tests ]; then
    # copy it so that we can write our *.ks files, fragments/, and so on
    rsync -r --exclude '/data/' /kickstart-tests/ $KSTESTS_DIR
else
    # if not given, check out current git
    git clone ${KSTESTS_REPOSITORY} ${KSTESTS_DIR}
    git -C ${KSTESTS_DIR} checkout ${KSTESTS_BRANCH}
    git -C ${KSTESTS_DIR} remote -v
fi

# Prepare the configuration
UPDATES_IMAGE_ARG=""
if [ -n "${UPDATES_IMAGE}" ]; then
  UPDATES_IMAGE_ARG="-u ${UPDATES_IMAGE}"
fi

TESTTYPE_ARG=""
if [ -n "${TESTTYPE}" ]; then
    TESTTYPE_ARG="-t ${TESTTYPE}"
fi

SKIP_TESTTYPES_ARG=""
if [ -n "${SKIP_TESTTYPES}" ]; then
    SKIP_TESTTYPES_ARG="-s ${SKIP_TESTTYPES}"
fi

# work around virt-install TOCTOU race <https://github.com/virt-manager/virt-manager/pull/175>
mkdir -p ~/.cache/virt-manager/boot

# Run the test, capture the output for run_report.sh
TEST_LOG=/var/tmp/kstest.log
pushd ${KSTESTS_DIR}
set +e
scripts/run_kickstart_tests.sh -k ${KSTESTS_KEEP} -i ${ISO_DIR}/${BOOT_ISO} ${UPDATES_IMAGE_ARG} ${TESTTYPE_ARG} ${SKIP_TESTTYPES_ARG} ${KSTESTS_TEST} 2>&1 | tee $TEST_LOG
RC=$?
set -e
popd

# Copy logs to a volume
# Fixup permissions
chmod -R a+r /var/tmp/kstest-*
# Clean up (artifacts from broken test)
find /var/tmp/kstest-* -name "*.iso" -delete
find /var/tmp/kstest-* -name "*.img" -delete
cp $TEST_LOG ${LOGS_DIR}
# Move to target logs directory; this sometimes fails on nested directory permission/ownership
cp -r /var/tmp/kstest-* ${LOGS_DIR} || true

# Show summary report
${KSTESTS_DIR}/scripts/run_report.sh < $TEST_LOG

exit $RC
